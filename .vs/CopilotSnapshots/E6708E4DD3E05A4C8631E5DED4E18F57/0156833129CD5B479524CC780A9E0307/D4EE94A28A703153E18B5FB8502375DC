using System;
using System.Collections.Generic;
using System.Configuration;
using System.Data;
using System.Data.SqlClient;
using System.Web.Mvc;

namespace MrLee.UI.Controllers
{
    public class ProductosController : Controller
    {
        private string _connectionString = ConfigurationManager.ConnectionStrings["MrLeeDB"]?.ConnectionString;

        // GET: Productos
        public ActionResult Index()
        {
            var productos = new List<dynamic>();
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = "SELECT id_producto, codigo, nombre, categoria, precio, stock, activo FROM dbo.productos ORDER BY id_producto DESC";
                        using (var reader = cmd.ExecuteReader())
                        {
                            while (reader.Read())
                            {
                                productos.Add(new
                                {
                                    id_producto = reader["id_producto"],
                                    codigo = reader["codigo"],
                                    nombre = reader["nombre"],
                                    categoria = reader["categoria"],
                                    precio = reader["precio"],
                                    stock = reader["stock"],
                                    activo = reader["activo"]
                                });
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
            }
            return View(productos);
        }

        // GET: Productos/Create
        public ActionResult Create()
        {
            return View();
        }

        // POST: Productos/Create
        [HttpPost]
        public ActionResult Create(string codigo, string nombre, string categoria, decimal precio, int stock)
        {
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = @"
                            INSERT INTO dbo.productos (codigo, nombre, categoria, precio, stock, activo)
                            VALUES (@codigo, @nombre, @categoria, @precio, @stock, 1)
                        ";
                        cmd.Parameters.AddWithValue("@codigo", codigo);
                        cmd.Parameters.AddWithValue("@nombre", nombre);
                        cmd.Parameters.AddWithValue("@categoria", string.IsNullOrEmpty(categoria) ? (object)DBNull.Value : categoria);
                        cmd.Parameters.AddWithValue("@precio", precio);
                        cmd.Parameters.AddWithValue("@stock", stock);
                        cmd.ExecuteNonQuery();
                    }
                }
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
                return View();
            }
        }

        // GET: Productos/Edit/5
        public ActionResult Edit(long id)
        {
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = "SELECT id_producto, codigo, nombre, categoria, precio, stock, activo FROM dbo.productos WHERE id_producto = @id";
                        cmd.Parameters.AddWithValue("@id", id);
                        using (var reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                ViewBag.Producto = new
                                {
                                    id_producto = reader["id_producto"],
                                    codigo = reader["codigo"],
                                    nombre = reader["nombre"],
                                    categoria = reader["categoria"],
                                    precio = reader["precio"],
                                    stock = reader["stock"],
                                    activo = reader["activo"]
                                };
                                return View();
                            }
                        }
                    }
                }
                return HttpNotFound();
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
                return View();
            }
        }

        // POST: Productos/Edit/5
        [HttpPost]
        public ActionResult Edit(long id, string codigo, string nombre, string categoria, decimal precio, int stock)
        {
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = @"
                            UPDATE dbo.productos
                            SET codigo = @codigo, nombre = @nombre, categoria = @categoria, precio = @precio, stock = @stock
                            WHERE id_producto = @id
                        ";
                        cmd.Parameters.AddWithValue("@id", id);
                        cmd.Parameters.AddWithValue("@codigo", codigo);
                        cmd.Parameters.AddWithValue("@nombre", nombre);
                        cmd.Parameters.AddWithValue("@categoria", string.IsNullOrEmpty(categoria) ? (object)DBNull.Value : categoria);
                        cmd.Parameters.AddWithValue("@precio", precio);
                        cmd.Parameters.AddWithValue("@stock", stock);
                        cmd.ExecuteNonQuery();
                    }
                }
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
                return View();
            }
        }

        // GET: Productos/Delete/5
        public ActionResult Delete(long id)
        {
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = "SELECT id_producto, codigo, nombre, categoria, precio, stock, activo FROM dbo.productos WHERE id_producto = @id";
                        cmd.Parameters.AddWithValue("@id", id);
                        using (var reader = cmd.ExecuteReader())
                        {
                            if (reader.Read())
                            {
                                ViewBag.Producto = new
                                {
                                    id_producto = reader["id_producto"],
                                    codigo = reader["codigo"],
                                    nombre = reader["nombre"],
                                    categoria = reader["categoria"],
                                    precio = reader["precio"],
                                    stock = reader["stock"],
                                    activo = reader["activo"]
                                };
                                return View();
                            }
                        }
                    }
                }
                return HttpNotFound();
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
                return View();
            }
        }

        // POST: Productos/Delete/5
        [HttpPost, ActionName("Delete")]
        public ActionResult DeleteConfirmed(long id)
        {
            try
            {
                using (var conn = new SqlConnection(_connectionString))
                {
                    conn.Open();
                    using (var cmd = conn.CreateCommand())
                    {
                        cmd.CommandText = "DELETE FROM dbo.productos WHERE id_producto = @id";
                        cmd.Parameters.AddWithValue("@id", id);
                        cmd.ExecuteNonQuery();
                    }
                }
                return RedirectToAction("Index");
            }
            catch (Exception ex)
            {
                ViewBag.Error = ex.Message;
                return View();
            }
        }
    }
}
